<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikTok è·é›¢ãƒ»æ­©æ•°ç®¡ç†ï¼ˆã‚ºãƒ¼ãƒ å¯¾ç­–ç‰ˆï¼‰</title>
    <style>
        :root { --primary: #fe2c55; --bg: #0f0f0f; --card: #1c1c1e; --accent: #25f4ee; }
        
        /* ã™ã¹ã¦ã®è¦ç´ ã§ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹åŒ–ã—ã€ã‚¿ãƒƒãƒ—ã®åå¿œã‚’é€Ÿã‚ã‚‹ */
        * {
            touch-action: manipulation;
            box-sizing: border-box;
        }

        body { font-family: sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        .container { width: 100%; max-width: 480px; }
        
        /* ãƒ¡ã‚¤ãƒ³è¡¨ç¤º */
        .main-card { background: var(--card); border-radius: 24px; padding: 25px; text-align: center; border: 1px solid #333; margin-bottom: 15px; }
        .dist-display { font-size: 3.2rem; font-weight: 900; color: var(--primary); margin: 5px 0; letter-spacing: -1px; line-height: 1.2; }
        .dist-display span { font-size: 1.5rem; color: #fff; margin-left: 5px; margin-right: 10px; }
        
        /* å€‹åˆ¥å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .edit-group { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .edit-row { display: flex; gap: 8px; align-items: center; justify-content: center; }
        .edit-row input { width: 90px; text-align: center; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; padding: 10px; font-size: 1rem; }
        .btn-set { background: var(--primary); color: #fff; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: bold; }

        /* å±¥æ­´ãƒ»ã‚®ãƒ•ãƒˆãƒœã‚¿ãƒ³ */
        .history-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-hist { flex: 1; background: #3a3a3c; color: #fff; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-hist:disabled { opacity: 0.2; }

        .gift-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-gift { background: var(--accent); color: #000; border: none; padding: 22px 10px; border-radius: 16px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: transform 0.05s; }
        .btn-gift:active { transform: scale(0.95); opacity: 0.8; }

        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        input, select { background: #2c2c2e; border: 1px solid #3d3d3f; color: #fff; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; }
        .btn-add { background: #fff; color: #000; border: none; padding: 14px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; }
        
        .file-ops { display: flex; gap: 10px; margin-top: 10px; }
        .btn-file { flex: 1; background: #444; color: #fff; border: none; padding: 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }
        .gift-item { display: flex; justify-content: space-between; align-items: center; background: #2c2c2e; padding: 12px; border-radius: 10px; margin-top: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <div style="font-size: 0.8rem; color: #888; margin-bottom: 5px;">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        <div class="dist-display"><span id="dispKm">0</span><span>km</span><span id="dispSteps">0</span><span>æ­©</span></div>
        
        <div class="edit-group">
            <div class="edit-row">
                <input type="number" id="inputKm" placeholder="0"> <span>km</span>
                <button class="btn-set" onclick="setKm()">ç¢ºå®š</button>
            </div>
            <div class="edit-row">
                <input type="number" id="inputSteps" placeholder="0"> <span>æ­©</span>
                <button class="btn-set" onclick="setSteps()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div class="history-controls">
        <button class="btn-hist" id="btnUndo" onclick="undo()">â—€ æˆ»ã‚‹</button>
        <button class="btn-hist" id="btnRedo" onclick="redo()">é€²ã‚€ â–¶</button>
    </div>

    <div class="gift-buttons" id="giftButtonContainer"></div>

    <div class="card">
        <strong style="display:block; margin-bottom:12px;">ğŸ è¨­å®š / ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</strong>
        <div style="display:flex; gap:8px; margin-bottom:10px;">
            <input type="text" id="gName" placeholder="ãƒãƒ©" style="flex:2; margin:0">
            <input type="number" id="gVal" placeholder="10" style="flex:1; margin:0">
            <select id="gUnit" style="flex:1.5; margin:0"><option value="steps">æ­©</option><option value="km">km</option></select>
        </div>
        <button class="btn-add" onclick="addGiftSetting()">ãƒœã‚¿ãƒ³ã‚’è¿½åŠ </button>
        
        <div class="file-ops">
            <button class="btn-file" onclick="exportData()">JSONä¿å­˜</button>
            <button class="btn-file" onclick="document.getElementById('fileInput').click()">JSONèª­ã¿è¾¼ã¿</button>
            <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importData(event)">
        </div>

        <div id="giftList" style="margin-top:10px;"></div>
    </div>

    <button onclick="hardReset()" style="background:none; border:none; color:#444; text-decoration:underline; width:100%; padding:15px; cursor:pointer;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’0ã«ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    // éå»ãƒ‡ãƒ¼ã‚¿ï¼ˆv7ç­‰ï¼‰ã®å¼•ãç¶™ããƒã‚§ãƒƒã‚¯
    let oldSteps = parseFloat(localStorage.getItem('v7_steps')) || 0;
    let oldSettings = JSON.parse(localStorage.getItem('v7_settings')) || [];
    
    // ç¾åœ¨ã®ç®¡ç†ãƒ‡ãƒ¼ã‚¿ï¼ˆv10ï¼‰
    let state = JSON.parse(localStorage.getItem('v10_state')) || { 
        km: Math.floor(oldSteps / 1000), 
        steps: Math.floor(oldSteps % 1000) 
    };
    
    let giftSettings = JSON.parse(localStorage.getItem('v10_settings'));
    if (!giftSettings) {
        if (oldSettings.length > 0) {
            giftSettings = oldSettings.map(s => ({
                name: s.name, 
                val: s.val, 
                type: s.mult === 1000 ? "km" : "steps"
            }));
        } else {
            giftSettings = [
                { name: "ãƒãƒ©", val: 10, type: "steps" },
                { name: "æŒ‡ãƒãƒ¼ãƒˆ", val: 50, type: "steps" }
            ];
        }
    }

    let history = [JSON.stringify(state)];
    let historyStep = 0;

    function updateUI() {
        document.getElementById('dispKm').innerText = state.km;
        document.getElementById('dispSteps').innerText = state.steps;
        document.getElementById('btnUndo').disabled = (historyStep <= 0);
        document.getElementById('btnRedo').disabled = (historyStep >= history.length - 1);

        const btnContainer = document.getElementById('giftButtonContainer');
        btnContainer.innerHTML = "";
        giftSettings.forEach(g => {
            const btn = document.createElement('button');
            btn.className = 'btn-gift';
            const unitText = g.type === "km" ? "km" : "æ­©";
            btn.innerText = `${g.name}\n(${g.val >= 0 ? "+" : ""}${g.val}${unitText})`;
            btn.onclick = () => changeValue(g.type, g.val);
            btnContainer.appendChild(btn);
        });

        const list = document.getElementById('giftList');
        list.innerHTML = "";
        giftSettings.forEach((g, i) => {
            list.innerHTML += `<div class="gift-item">
                <span>${g.name} (${g.val}${g.type === "km" ? 'km' : 'æ­©'})</span>
                <button onclick="deleteGift(${i})" style="background:#ff3b30; color:#fff; border:none; border-radius:5px; padding:5px 10px;">å‰Šé™¤</button>
            </div>`;
        });

        localStorage.setItem('v10_state', JSON.stringify(state));
        localStorage.setItem('v10_settings', JSON.stringify(giftSettings));
    }

    // --- å„ç¨®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
    function changeValue(type, val) {
        state[type] += val;
        saveHistory();
        updateUI();
    }

    function setKm() {
        const val = parseFloat(document.getElementById('inputKm').value);
        if (!isNaN(val)) { state.km = val; saveHistory(); updateUI(); document.getElementById('inputKm').value = ""; }
    }

    function setSteps() {
        const val = parseFloat(document.getElementById('inputSteps').value);
        if (!isNaN(val)) { state.steps = val; saveHistory(); updateUI(); document.getElementById('inputSteps').value = ""; }
    }

    function saveHistory() {
        history = history.slice(0, historyStep + 1);
        history.push(JSON.stringify(state));
        if (history.length > 50) history.shift();
        historyStep = history.length - 1;
    }

    function undo() { if (historyStep > 0) { historyStep--; state = JSON.parse(history[historyStep]); updateUI(); } }
    function redo() { if (historyStep < history.length - 1) { historyStep++; state = JSON.parse(history[historyStep]); updateUI(); } }

    function addGiftSetting() {
        const n = document.getElementById('gName').value;
        const v = parseFloat(document.getElementById('gVal').value);
        const t = document.getElementById('gUnit').value;
        if (n && !isNaN(v)) { giftSettings.push({ name: n, val: v, type: t }); updateUI(); }
    }

    function deleteGift(i) { giftSettings.splice(i, 1); updateUI(); }

    function hardReset() {
        if (confirm("kmã¨æ­©æ•°ã‚’ã™ã¹ã¦0ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿï¼ˆãƒœã‚¿ãƒ³è¨­å®šã¯æ¶ˆãˆã¾ã›ã‚“ï¼‰")) {
            state = { km: 0, steps: 0 };
            saveHistory();
            updateUI();
        }
    }

    // --- JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ---
    function exportData() {
        const data = { state, giftSettings };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tiktok_distance_backup.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                state = data.state; giftSettings = data.giftSettings;
                history = [JSON.stringify(state)]; historyStep = 0;
                updateUI();
                alert("ãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«å¾©å…ƒã—ã¾ã—ãŸï¼");
            } catch (err) { alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); }
        };
        reader.readAsText(file);
    }

    updateUI();
</script>
</body>
</html>
