<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTokè‡ªå‹•è·é›¢è¨ˆç®— - é«˜è¦–èªæ€§ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.4/dist/socket.io.min.js"></script>
    <script src="https://unpkg.com/bubbles-tiktok-connector@1.0.0/dist/bubbles-tiktok-connector.min.js"></script>
    <style>
        :root { --primary: #fe2c55; --online: #25f4ee; --offline: #555; --bg: #0f0f0f; }
        body { font-family: sans-serif; background: var(--bg); color: white; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 450px; }
        
        /* æ¥ç¶šçŠ¶æ…‹ã‚«ãƒ¼ãƒ‰ */
        .status-card { background: #1a1a1a; border-radius: 20px; padding: 25px; text-align: center; border: 2px solid var(--offline); transition: 0.3s; margin-bottom: 15px; }
        .status-card.active { border-color: var(--online); box-shadow: 0 0 20px rgba(37, 244, 238, 0.3); }
        
        /* æ¥ç¶šä¸­ãƒ©ãƒ³ãƒ— */
        .indicator { width: 15px; height: 15px; background: var(--offline); border-radius: 50%; display: inline-block; margin-right: 10px; }
        .active .indicator { background: var(--online); box-shadow: 0 0 10px var(--online); animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .status-text { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .dist-display { font-size: 4rem; font-weight: bold; color: var(--primary); margin: 15px 0; letter-spacing: -2px; }
        
        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .card { background: #222; border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        input, select { background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1rem; }
        .btn { cursor: pointer; border: none; border-radius: 8px; padding: 15px; font-weight: bold; width: 100%; transition: 0.2s; font-size: 1.1rem; }
        .btn-connect { background: var(--primary); color: white; margin-top: 10px; }
        .btn-disconnect { background: #444; color: white; margin-top: 10px; display: none; }
        
        .gift-item { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 5px solid var(--online); }
        .log-area { background: #000; padding: 10px; border-radius: 10px; font-size: 0.8rem; color: #aaa; height: 50px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="status-card" id="mainCard">
        <div class="status-text"><span class="indicator"></span><span id="statusTxt">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span></div>
        <div id="targetUser" style="color:#888; margin-bottom:10px;">æ¥ç¶šå…ˆ: æœªæŒ‡å®š</div>
        <div class="dist-display" id="totalDist">0 m</div>
        <div style="color: #666; font-size: 0.9rem;">ç´¯è¨ˆ: <span id="totalM">0</span>m</div>
    </div>

    <div class="card">
        <input type="text" id="tiktokId" placeholder="TikTok ID (@ãªã—)">
        <button class="btn btn-connect" id="btnConnect" onclick="connectTikTok()">è‡ªå‹•è¨ˆæ¸¬ã‚’é–‹å§‹ã™ã‚‹</button>
        <button class="btn btn-disconnect" id="btnDisconnect" onclick="disconnectTikTok()">æ¥ç¶šã‚’è§£é™¤</button>
        <div class="log-area" id="log">ãƒ­ã‚°: å¾…æ©Ÿä¸­...</div>
    </div>

    <div class="card">
        <strong style="display:block; margin-bottom:10px;">ğŸ åˆ¤å®šã‚®ãƒ•ãƒˆã®ç™»éŒ²</strong>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="newName" placeholder="åå‰" style="flex:2">
            <input type="number" id="newVal" placeholder="è·é›¢" style="flex:1">
            <select id="newUnit" style="flex:1"><option value="1">m</option><option value="1000">km</option></select>
        </div>
        <button class="btn" style="background:var(--online); color:#000;" onclick="saveSetting()">è¨­å®šã‚’è¿½åŠ </button>
        <div id="giftListDisplay" style="margin-top:20px;"></div>
    </div>

    <button onclick="resetData()" style="background:none; border:none; color:#555; text-decoration:underline; width:100%; margin-top:20px;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    let giftSettings = JSON.parse(localStorage.getItem('tk_pro_settings')) || [];
    let totalMeters = parseFloat(localStorage.getItem('tk_pro_total')) || 0;
    let connection = null;

    function updateUI() {
        const isKm = Math.abs(totalMeters) >= 1000;
        document.getElementById('totalDist').innerText = isKm ? (totalMeters/1000).toFixed(2) + " km" : Math.round(totalMeters) + " m";
        document.getElementById('totalM').innerText = Math.round(totalMeters).toLocaleString();
        
        const listDiv = document.getElementById('giftListDisplay');
        listDiv.innerHTML = "";
        giftSettings.forEach((g, i) => {
            const unit = g.mult == 1000 ? "km" : "m";
            listDiv.innerHTML += `<div class="gift-item">
                <span><strong>${g.name}</strong>: ${g.val > 0 ? '+'+g.val : g.val}${unit}</span>
                <button style="background:#ff4d4d; color:white; border:none; padding:5px 10px; border-radius:5px;" onclick="deleteSetting(${i})">å‰Šé™¤</button>
            </div>`;
        });
        localStorage.setItem('tk_pro_settings', JSON.stringify(giftSettings));
        localStorage.setItem('tk_pro_total', totalMeters);
    }

    function connectTikTok() {
        const user = document.getElementById('tiktokId').value.trim();
        if(!user) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const card = document.getElementById('mainCard');
        const statusTxt = document.getElementById('statusTxt');
        const log = document.getElementById('log');

        statusTxt.innerText = "æ¥ç¶šä¸­...";
        log.innerText = "TikTok LIVEã¸æ¥ç¶šã‚’è©¦ã¿ã¦ã„ã¾ã™...";

        connection = new TikTokLiveConnector.TikTokLiveConnection(user);

        connection.connect().then(() => {
            card.classList.add('active');
            statusTxt.innerText = "LIVEç›£è¦–ä¸­";
            document.getElementById('targetUser').innerText = "æ¥ç¶šå…ˆ: @" + user;
            document.getElementById('btnConnect').style.display = "none";
            document.getElementById('btnDisconnect').style.display = "block";
            log.innerText = "æ¥ç¶šå®Œäº†ï¼ã‚®ãƒ•ãƒˆã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™ã€‚";
        }).catch(err => {
            alert("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ©ã‚¤ãƒ–ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            statusTxt.innerText = "æ¥ç¶šå¤±æ•—";
        });

        connection.on('gift', data => {
            log.innerText = `å—ä¿¡ä¸­: ${data.giftName} x${data.repeatCount}`;
            // æ›–æ˜§åˆ¤å®šï¼ˆã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠãƒ»éƒ¨åˆ†ä¸€è‡´ï¼‰
            const setting = giftSettings.find(s => data.giftName.includes(s.name) || s.name.includes(data.giftName));
            if(setting) {
                totalMeters += (setting.val * setting.mult) * data.repeatCount;
                updateUI();
            }
        });
    }

    function disconnectTikTok() {
        if(connection) connection.disconnect();
        document.getElementById('mainCard').classList.remove('active');
        document.getElementById('statusTxt').innerText = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
        document.getElementById('btnConnect').style.display = "block";
        document.getElementById('btnDisconnect').style.display = "none";
        document.getElementById('log').innerText = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚";
    }

    function saveSetting() {
        const n = document.getElementById('newName').value;
        const v = document.getElementById('newVal').value;
        const m = document.getElementById('newUnit').value;
        if(n && v) {
            giftSettings.push({ name: n, val: parseFloat(v), mult: parseInt(m) });
            updateUI();
            document.getElementById('newName').value = "";
            document.getElementById('newVal').value = "";
        }
    }

    function deleteSetting(i) { giftSettings.splice(i, 1); updateUI(); }
    function resetData() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { totalMeters = 0; updateUI(); } }
    updateUI();
</script>
</body>
</html>
