<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTokè‡ªå‹•è·é›¢è¨ˆç®—æ©ŸPro - å®Œå…¨ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.5.4/dist/socket.io.min.js"></script>
    <script src="https://unpkg.com/bubbles-tiktok-connector@1.0.0/dist/bubbles-tiktok-connector.min.js"></script>
    <style>
        :root { --primary: #fe2c55; --online: #25f4ee; --offline: #555; --bg: #0f0f0f; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: white; padding: 20px; display: flex; flex-direction: column; align-items: center; margin: 0; }
        .container { width: 100%; max-width: 450px; }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-card { background: #1a1a1a; border-radius: 20px; padding: 25px; text-align: center; border: 2px solid var(--offline); transition: 0.4s; margin-bottom: 15px; position: relative; overflow: hidden; }
        .status-card.active { border-color: var(--online); box-shadow: 0 0 25px rgba(37, 244, 238, 0.2); }
        
        /* æ¥ç¶šä¸­ãƒ©ãƒ³ãƒ— */
        .indicator { width: 12px; height: 12px; background: var(--offline); border-radius: 50%; display: inline-block; margin-right: 8px; }
        .active .indicator { background: var(--online); box-shadow: 0 0 10px var(--online); animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .status-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }
        .dist-display { font-size: 4rem; font-weight: bold; color: var(--primary); margin: 10px 0; letter-spacing: -2px; }
        
        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card { background: #222; border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        input, select { background: #333; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 1rem; margin-bottom: 10px; }
        .btn { cursor: pointer; border: none; border-radius: 8px; padding: 15px; font-weight: bold; width: 100%; transition: 0.2s; font-size: 1.1rem; }
        .btn-connect { background: var(--primary); color: white; }
        .btn-disconnect { background: #444; color: white; display: none; }
        
        /* ã‚®ãƒ•ãƒˆãƒªã‚¹ãƒˆ */
        .gift-item { display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 5px solid var(--online); }
        .log-area { background: #000; padding: 10px; border-radius: 8px; font-size: 0.8rem; color: #888; height: 60px; overflow-y: auto; margin-top: 10px; border: 1px solid #222; }
        .delete-btn { background: #ff4d4d; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="status-card" id="mainCard">
        <div class="status-text"><span class="indicator"></span><span id="statusTxt">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span></div>
        <div id="targetUser" style="color:#666; font-size: 0.9rem;">æ¥ç¶šå…ˆ: æœªæŒ‡å®š</div>
        <div class="dist-display" id="totalDist">0 m</div>
        <div style="color: #888; font-size: 0.9rem;">ç´¯è¨ˆæ­©è¡Œè·é›¢: <span id="totalM">0</span>m</div>
    </div>

    <div class="card">
        <input type="text" id="tiktokId" placeholder="TikTok ID (@ãªã—)">
        <button class="btn btn-connect" id="btnConnect" onclick="connectTikTok()">ãƒ©ã‚¤ãƒ–ç›£è¦–ã‚’é–‹å§‹</button>
        <button class="btn btn-disconnect" id="btnDisconnect" onclick="disconnectTikTok()">æ¥ç¶šã‚’è§£é™¤</button>
        <div class="log-area" id="log">ãƒ­ã‚°: IDã‚’å…¥åŠ›ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„</div>
    </div>

    <div class="card">
        <strong style="display:block; margin-bottom:12px; font-size: 1rem;">ğŸ ã‚®ãƒ•ãƒˆåˆ¤å®šã®è¿½åŠ </strong>
        <div style="display:flex; gap:8px;">
            <input type="text" id="newName" placeholder="ã‚®ãƒ•ãƒˆå" style="flex:2">
            <input type="number" id="newVal" placeholder="æ•°å€¤" style="flex:1">
            <select id="newUnit" style="flex:1">
                <option value="1">m</option>
                <option value="1000">km</option>
            </select>
        </div>
        <button class="btn" style="background:var(--online); color:#000; padding: 10px;" onclick="saveSetting()">è¨­å®šã‚’ä¿å­˜</button>
        
        <div id="giftListDisplay" style="margin-top:20px;">
            </div>
    </div>

    <button onclick="resetData()" style="background:none; border:none; color:#555; text-decoration:underline; width:100%; padding: 20px; cursor: pointer;">ã™ã¹ã¦ã®è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    // ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    let giftSettings = JSON.parse(localStorage.getItem('tk_v3_settings')) || [
        { name: "ãƒãƒ©", val: 10, mult: 1 },
        { name: "æŒ‡ãƒãƒ¼ãƒˆ", val: 50, mult: 1 }
    ];
    let totalMeters = parseFloat(localStorage.getItem('tk_v3_total')) || 0;
    let connection = null;

    // ç”»é¢ã®æ›´æ–°å‡¦ç†
    function updateUI() {
        const absM = Math.abs(totalMeters);
        const displayStr = absM >= 1000 ? (totalMeters/1000).toFixed(2) + " km" : Math.round(totalMeters) + " m";
        document.getElementById('totalDist').innerText = displayStr;
        document.getElementById('totalM').innerText = Math.round(totalMeters).toLocaleString();
        
        const listDiv = document.getElementById('giftListDisplay');
        listDiv.innerHTML = giftSettings.length ? "" : "<p style='color:#555; text-align:center;'>è¨­å®šã•ã‚ŒãŸã‚®ãƒ•ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>";
        
        giftSettings.forEach((g, i) => {
            const unitText = g.mult == 1000 ? "km" : "m";
            const valText = g.val > 0 ? "+" + g.val : g.val;
            listDiv.innerHTML += `
                <div class="gift-item">
                    <span><strong>${g.name}</strong> (${valText}${unitText})</span>
                    <button class="delete-btn" onclick="deleteSetting(${i})">å‰Šé™¤</button>
                </div>`;
        });

        localStorage.setItem('tk_v3_settings', JSON.stringify(giftSettings));
        localStorage.setItem('tk_v3_total', totalMeters);
    }

    // TikTok LIVE æ¥ç¶šå‡¦ç†
    function connectTikTok() {
        const user = document.getElementById('tiktokId').value.trim().replace('@', '');
        if(!user) { alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: tukit0805ï¼‰"); return; }

        const card = document.getElementById('mainCard');
        const statusTxt = document.getElementById('statusTxt');
        const log = document.getElementById('log');

        statusTxt.innerText = "æ¥ç¶šä¸­...";
        log.innerText = `@${user} ã®ãƒ©ã‚¤ãƒ–ã‚’æ¢ã—ã¦ã„ã¾ã™...`;

        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        connection = new TikTokLiveConnector.TikTokLiveConnection(user);

        connection.connect().then(() => {
            card.classList.add('active');
            statusTxt.innerText = "LIVEç›£è¦–ä¸­";
            document.getElementById('targetUser').innerText = "æ¥ç¶šå…ˆ: @" + user;
            document.getElementById('btnConnect').style.display = "none";
            document.getElementById('btnDisconnect').style.display = "block";
            log.innerText = "æ¥ç¶šæˆåŠŸï¼ã‚®ãƒ•ãƒˆãŒæŠ•ã’ã‚‰ã‚Œã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...";
        }).catch(err => {
            console.error(err);
            statusTxt.innerText = "æ¥ç¶šå¤±æ•—";
            log.innerText = "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚é…ä¿¡ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        });

        // ã‚®ãƒ•ãƒˆå—ä¿¡æ™‚ã®å‡¦ç†
        connection.on('gift', data => {
            log.innerText = `å—ä¿¡ãƒ­ã‚°: ${data.giftName} x${data.repeatCount}`;
            
            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆåå‰ã®æºã‚Œã«å¯¾å¿œï¼‰
            const setting = giftSettings.find(s => {
                const incoming = data.giftName.toLowerCase();
                const stored = s.name.toLowerCase();
                return incoming.includes(stored) || stored.includes(incoming);
            });

            if(setting) {
                const addDist = (setting.val * setting.mult) * data.repeatCount;
                totalMeters += addDist;
                updateUI();
            }
        });
    }

    // åˆ‡æ–­å‡¦ç†
    function disconnectTikTok() {
        if(connection) connection.disconnect();
        document.getElementById('mainCard').classList.remove('active');
        document.getElementById('statusTxt').innerText = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
        document.getElementById('btnConnect').style.display = "block";
        document.getElementById('btnDisconnect').style.display = "none";
        document.getElementById('log').innerText = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚";
    }

    // è¨­å®šã®ä¿å­˜
    function saveSetting() {
        const name = document.getElementById('newName').value.trim();
        const val = document.getElementById('newVal').value;
        const mult = document.getElementById('newUnit').value;
        if(name && val) {
            giftSettings.push({ name, val: parseFloat(val), mult: parseInt(mult) });
            updateUI();
            document.getElementById('newName').value = "";
            document.getElementById('newVal').value = "";
        }
    }

    function deleteSetting(i) { giftSettings.splice(i, 1); updateUI(); }
    function resetData() { if(confirm("è·é›¢ã¨ç´¯è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) { totalMeters = 0; updateUI(); } }

    // åˆæœŸè¡¨ç¤º
    updateUI();
</script>
</body>
</html>
<body>

<div class="container">
    <div class="status-card" id="mainCard">
        <div class="status-text"><span class="indicator"></span><span id="statusTxt">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span></div>
        <div id="targetUser" style="color:#888; margin-bottom:10px;">æ¥ç¶šå…ˆ: æœªæŒ‡å®š</div>
        <div class="dist-display" id="totalDist">0 m</div>
        <div style="color: #666; font-size: 0.9rem;">ç´¯è¨ˆ: <span id="totalM">0</span>m</div>
    </div>

    <div class="card">
        <input type="text" id="tiktokId" placeholder="TikTok ID (@ãªã—)">
        <button class="btn btn-connect" id="btnConnect" onclick="connectTikTok()">è‡ªå‹•è¨ˆæ¸¬ã‚’é–‹å§‹ã™ã‚‹</button>
        <button class="btn btn-disconnect" id="btnDisconnect" onclick="disconnectTikTok()">æ¥ç¶šã‚’è§£é™¤</button>
        <div class="log-area" id="log">ãƒ­ã‚°: å¾…æ©Ÿä¸­...</div>
    </div>

    <div class="card">
        <strong style="display:block; margin-bottom:10px;">ğŸ åˆ¤å®šã‚®ãƒ•ãƒˆã®ç™»éŒ²</strong>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="newName" placeholder="åå‰" style="flex:2">
            <input type="number" id="newVal" placeholder="è·é›¢" style="flex:1">
            <select id="newUnit" style="flex:1"><option value="1">m</option><option value="1000">km</option></select>
        </div>
        <button class="btn" style="background:var(--online); color:#000;" onclick="saveSetting()">è¨­å®šã‚’è¿½åŠ </button>
        <div id="giftListDisplay" style="margin-top:20px;"></div>
    </div>

    <button onclick="resetData()" style="background:none; border:none; color:#555; text-decoration:underline; width:100%; margin-top:20px;">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
    let giftSettings = JSON.parse(localStorage.getItem('tk_pro_settings')) || [];
    let totalMeters = parseFloat(localStorage.getItem('tk_pro_total')) || 0;
    let connection = null;

    function updateUI() {
        const isKm = Math.abs(totalMeters) >= 1000;
        document.getElementById('totalDist').innerText = isKm ? (totalMeters/1000).toFixed(2) + " km" : Math.round(totalMeters) + " m";
        document.getElementById('totalM').innerText = Math.round(totalMeters).toLocaleString();
        
        const listDiv = document.getElementById('giftListDisplay');
        listDiv.innerHTML = "";
        giftSettings.forEach((g, i) => {
            const unit = g.mult == 1000 ? "km" : "m";
            listDiv.innerHTML += `<div class="gift-item">
                <span><strong>${g.name}</strong>: ${g.val > 0 ? '+'+g.val : g.val}${unit}</span>
                <button style="background:#ff4d4d; color:white; border:none; padding:5px 10px; border-radius:5px;" onclick="deleteSetting(${i})">å‰Šé™¤</button>
            </div>`;
        });
        localStorage.setItem('tk_pro_settings', JSON.stringify(giftSettings));
        localStorage.setItem('tk_pro_total', totalMeters);
    }

    function connectTikTok() {
        const user = document.getElementById('tiktokId').value.trim();
        if(!user) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const card = document.getElementById('mainCard');
        const statusTxt = document.getElementById('statusTxt');
        const log = document.getElementById('log');

        statusTxt.innerText = "æ¥ç¶šä¸­...";
        log.innerText = "TikTok LIVEã¸æ¥ç¶šã‚’è©¦ã¿ã¦ã„ã¾ã™...";

        connection = new TikTokLiveConnector.TikTokLiveConnection(user);

        connection.connect().then(() => {
            card.classList.add('active');
            statusTxt.innerText = "LIVEç›£è¦–ä¸­";
            document.getElementById('targetUser').innerText = "æ¥ç¶šå…ˆ: @" + user;
            document.getElementById('btnConnect').style.display = "none";
            document.getElementById('btnDisconnect').style.display = "block";
            log.innerText = "æ¥ç¶šå®Œäº†ï¼ã‚®ãƒ•ãƒˆã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™ã€‚";
        }).catch(err => {
            alert("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ©ã‚¤ãƒ–ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            statusTxt.innerText = "æ¥ç¶šå¤±æ•—";
        });

        connection.on('gift', data => {
            log.innerText = `å—ä¿¡ä¸­: ${data.giftName} x${data.repeatCount}`;
            // æ›–æ˜§åˆ¤å®šï¼ˆã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠãƒ»éƒ¨åˆ†ä¸€è‡´ï¼‰
            const setting = giftSettings.find(s => data.giftName.includes(s.name) || s.name.includes(data.giftName));
            if(setting) {
                totalMeters += (setting.val * setting.mult) * data.repeatCount;
                updateUI();
            }
        });
    }

    function disconnectTikTok() {
        if(connection) connection.disconnect();
        document.getElementById('mainCard').classList.remove('active');
        document.getElementById('statusTxt').innerText = "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³";
        document.getElementById('btnConnect').style.display = "block";
        document.getElementById('btnDisconnect').style.display = "none";
        document.getElementById('log').innerText = "åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚";
    }

    function saveSetting() {
        const n = document.getElementById('newName').value;
        const v = document.getElementById('newVal').value;
        const m = document.getElementById('newUnit').value;
        if(n && v) {
            giftSettings.push({ name: n, val: parseFloat(v), mult: parseInt(m) });
            updateUI();
            document.getElementById('newName').value = "";
            document.getElementById('newVal').value = "";
        }
    }

    function deleteSetting(i) { giftSettings.splice(i, 1); updateUI(); }
    function resetData() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { totalMeters = 0; updateUI(); } }
    updateUI();
</script>
</body>
</html>
